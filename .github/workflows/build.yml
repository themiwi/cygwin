name: CI

on:
  push:
    branches: [ master, feature/** ]
  pull_request:
    branches: [ master ]

jobs:
  docker-image:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2

    - name: Login to DockerHub
      run: docker login -u michaelwild -p "${{ secrets.DOCKERHUB_PASSWORD }}"

    - name: Builds docker image
      run: docker build --pull --cache-from=michaelwild/cygwin-build:latest --tag michaelwild/cygwin-build:latest .github/docker/cygwin-build

    - name: Pushes the docker image
      run: docker push michaelwild/cygwin-build:latest

  python-bcrypt:
    needs: docker-image
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: docker run -v ${{ github.Workspace }}:C:/Workspace michaelwild/cygwin-build cygport /build/python-bcrypt/python-bcrypt.cygport fetch all

    - uses: actions/upload-artifact@v2
      with:
        name: python-bcrypt
        path: python-bcrypt/python-bcrypt-*.x86_64/dist/python-bcrypt/

  python-nacl:
    needs: docker-image
    container: michaelwild/cygwin-build:latest
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: docker run -v ${{ github.Workspace }}:C:/Workspace michaelwild/cygwin-build cygport /build/python-nacl/python-nacl.cygport fetch all

    - uses: actions/upload-artifact@v2
      with:
        name: python-nacl
        path: python-nacl/python-nacl-*.x86_64/dist/python-nacl/

  python-paramiko:
    needs:
      - python-bcrypt
      - python-nacl
    container: michaelwild/cygwin-build:latest
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2

    - name: Build
      run: docker run -v ${{ github.Workspace }}:C:/Workspace michaelwild/cygwin-build cygport /build/python-paramiko/python-paramiko.cygport fetch all

    - uses: actions/upload-artifact@v2
      with:
        name: python-paramiko
        path: python-paramiko/python-paramiko-*.noarch/dist/python-paramiko/

  ssh-pageant:
    needs: docker-image
    container: michaelwild/cygwin-build:latest
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2

    - name: Build
      run: docker run -v ${{ github.Workspace }}:C:/Workspace michaelwild/cygwin-build cygport /build/ssh-pageant/ssh-pageant.cygport fetch all

    - uses: actions/upload-artifact@v2
      with:
        name: ssh-pageant
        path: ssh-pageant/ssh-pageant-*.x86_64/dist/ssh-pageant/

  tmux:
    needs: docker-image
    container: michaelwild/cygwin-build:latest
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2

    - name: Build
      run: docker run -v ${{ github.Workspace }}:C:/Workspace michaelwild/cygwin-build cygport /build/tmux/tmux.cygport fetch all

    - uses: actions/upload-artifact@v2
      with:
        name: tmux
        path: tmux/tmux-*.x86_64/dist/tmux/
